<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title> Implementing a Protocol - Instant Messaging | Jitsi</title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel="shortcut icon" href="../wiki/pub/skins/simple/i/favicon.ico" type="image/x-icon">
  <link rel="icon" href="../wiki/pub/skins/simple/i/favicon.ico" type="image/x-icon">
  <link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
  <!-- link rel='stylesheet' href='https://desktop.jitsi.org/wiki/pub/skins/simple/pmwiki.css' type='text/css' / -->
  <link rel='stylesheet' href='../wiki/pub/skins/simple/simple.css' type='text/css' />
  <!--[if IE 6]><link type="text/css" rel="stylesheet" href="css/ie6.css" /><![endif]-->
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .vspace { margin-top:1.33em; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  .apprlink { font-size:smaller; }
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 5px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
div.toc p { background-color: #f9f6d6;
    margin-top:-5px;   padding-top: 5px;
    margin-left:-5px;  padding-left: 5px;
    margin-right:-5px; padding-right: 5px;
    padding-bottom: 3px;
    border-bottom:  1px dotted #cccccc; }
div.breaklist { text-align: right; }
div.breaklist strong { background-color: yellow; }
div.breakpage { text-align: right; }.editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
   
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }
/* GeSHi (C) 2004 - 2007 Nigel McNie (http://qbnz.com/highlighter) */
.java  {font-family: monospace;}
.java .imp {font-weight: bold; color: red;}
.java .kw1 {color: #7F0055; font-weight: bold}
.java .kw2 {color: #7F0055; font-weight: bold;}
.java .kw3 {color: #aaaadd; font-weight: bold;}
.java .kw4 {color: #993333;}
.java .co1 {color: #3F7F5F; font-style: italic;}
.java .co2 {color: #a1a100;}
.java .coMULTI {color: #3F7F5F; font-style: italic;}
.java .es0 {color: #000099; font-weight: bold;}
.java .br0 {color: #666;}
.java .st0 {color: #2A00FF;}
.java .nu0 {color: #cc66cc;}
.java .me1 {color: #666;}
.java .me2 {color: #666;}

.sourceblocklink {
  text-align: right;
  font-size: smaller;
}
.sourceblocktext {
  padding: 0.5em;
  border: 1px solid #808080;
  background-color: #f1f0ed;
}
.sourceblocktext div {
  font-family: monospace;
  font-size: small;
  line-height: 1;
  height: 1%;
}
.sourceblocktext div.head,
.sourceblocktext div.foot {
  font: italic medium serif;
  padding: 0.5em;
}

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script><link rel='stylesheet' href='../wiki/pub/css/markup.css' type='text/css' />

  <link href='../wiki/pub/commentboxplus/commentboxplus.css' rel='stylesheet' type='text/css' />  <meta name='robots' content='index,follow' />

<!-- google analytics tracker -->

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-319188-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- end google analytics tracker -->

<script type="text/javascript">
	<!--//--><![CDATA[//><!--
    startList = 
    	function() 
        {
        	if (document.all && document.getElementById) {
            	navRoot = document.getElementById("menu");
                for (i = 0; i < navRoot.childNodes.length; i++) {
                	node = navRoot.childNodes[i];
                    if (node.nodeName == "LI") {
                    	node.onmouseover = 
                        	function() { this.className += " over"; }
                        node.onmouseout = 
                        	function() { this.className = this.className.replace(" over", ""); }
                    }
                }
            }
        }
	window.onload = startList;
    //--><!]]>
</script>

<script language="JavaScript1.1">
<!--
	first = 1;
    last = 5;
    current = 0;
    var slideTimerId = 0;
	var buttonLink = "";
    var osName="Unknown OS";
            
    function nextPicture()
	{
	    removeCurrent();

	    // Show next picture, if last, loop back to front
    	if (current == last) { current = 1; }
        else { current++ }

		addCurrent();
		
		restartTimer();	
	}

    function previousPicture()
	{
		removeCurrent();

        if (current == first) { current = last; }
        else { current--; }
        
		addCurrent();

		restartTimer();	
	}
	
	function goToSlide(index)
	{         
		removeCurrent();

        current = index;

        addCurrent();

		restartTimer();	
	}
	
	function removeCurrent()
	{
		if (current != 0)
		{
	    	// Hide current picture
    	    object = document.getElementById('slide' + current);
        	object.style.display = 'none';
 
			fade('slide' + current);

            object = document.getElementById('dot' + current);
	        object.style.backgroundImage = "url(https://desktop.jitsi.org/wiki/pub/sip-communicator/dot.png)";
		}
	}
	
	function addCurrent()
	{
		object = document.getElementById('slide' + current);
		object.style.opacity = 0;
        object.style.display = 'block';

        fade('slide' + current);

		object = document.getElementById('dot' + current);
        object.style.backgroundImage = "url(https://desktop.jitsi.org/wiki/pub/sip-communicator/dotSelected.png)";
	}

	function restartTimer()
	{
		clearTimeout(slideTimerId);
		slideTimerId = setTimeout("slideit()", slideshowspeed);
	}

	var TimeToFade = 500.0;

	function fade(eid)
	{
	  	var element = document.getElementById(eid);
  		if(element == null)
    		return;
   
  		if(element.FadeState == null)
  		{
    		if(element.style.opacity == '1')
		    {
      			element.FadeState = 2;
    		}
    		else if (element.style.opacity == null
					|| element.style.opacity == '0'
					|| element.style.opacity == '')
    		{
      			element.FadeState = -2;
    		}
  		}
    
  		if(element.FadeState == 1 || element.FadeState == -1)
  		{
    		element.FadeState = element.FadeState == 1 ? -1 : 1;
    		element.FadeTimeLeft = TimeToFade - element.FadeTimeLeft;
  		}
  		else
  		{
    		element.FadeState = element.FadeState == 2 ? -1 : 1;
    		element.FadeTimeLeft = TimeToFade;
    		setTimeout("animateFade(" + new Date().getTime() + ",'" + eid + "')", 33);
  		}  
	}

	function animateFade(lastTick, eid)
	{  
  		var curTick = new Date().getTime();
		var elapsedTicks = curTick - lastTick;
  
  		var element = document.getElementById(eid);
 
  		if(element.FadeTimeLeft <= elapsedTicks)
  		{
    		element.style.opacity = element.FadeState == 1 ? '1' : '0';
    		element.style.filter = 'alpha(opacity = ' 
        		+ (element.FadeState == 1 ? '100' : '0') + ')';
	    	element.FadeState = element.FadeState == 1 ? 2 : -2;
		    return;
  		}
 
	  	element.FadeTimeLeft -= elapsedTicks;
  		var newOpVal = element.FadeTimeLeft/TimeToFade;
  		if(element.FadeState == 1)
	    	newOpVal = 1 - newOpVal;

  		element.style.opacity = newOpVal;
 	 	element.style.filter = 'alpha(opacity = ' + (newOpVal*100) + ')';
  
	  	setTimeout("animateFade(" + curTick + ",'" + eid + "')", 33);
	}
	
	function createCORSRequest(method, url)
	{
    	var xhr = new XMLHttpRequest();
	    if ("withCredentials" in xhr)
		{
    	    xhr.open(method, url, true);
	    }
		else if (typeof XDomainRequest != "undefined")
		{
        	xhr = new XDomainRequest();
        	xhr.open(method, url);
	    }
		else
		{
        	xhr = null;
    	}
    	return xhr;
	}

	function createDownloadText()
	{
		if (navigator.appVersion.indexOf("Win")!=-1)
			osName="Windows";
		if (navigator.appVersion.indexOf("Mac")!=-1)
			osName="Mac OS X";
		if (navigator.appVersion.indexOf("X11")!=-1)
			osName="Unix";
		if (navigator.appVersion.indexOf("Linux")!=-1)
			osName="Linux";
		
		return "Get Jitsi for " + osName;
	}

	function getOsName()
	{
	    var os = "";
		if (navigator.appVersion.indexOf("Win")!=-1)
			os="windows";
		if (navigator.appVersion.indexOf("Mac")!=-1)
			os="macosx";
		if (navigator.appVersion.indexOf("Linux")!=-1)
			os="linux";
		
		return os;
	}

	function getDownloadURL()
	{
	    var url = "";
		if (navigator.appVersion.indexOf("Win")!=-1)
			url="https://download.jitsi.org/nightly/windows/";
		if (navigator.appVersion.indexOf("Mac")!=-1)
			url="https://download.jitsi.org/nightly/macosx/";
		if (navigator.appVersion.indexOf("Linux")!=-1)
			url="https://download.jitsi.org/nightly/linux/";
		
		return url;
	}

    function createDownloadLink()
	{
		var txtFile = createCORSRequest("get", getDownloadURL() + "versionupdate.properties");
        txtFile.onreadystatechange = function()
        {
            if (txtFile.readyState == 4)
            {  // Makes sure the document is ready to parse.
				display_all(txtFile.responseText);
                buttonLink = getDownloadURL() + txtFile.responseText;
            }
        }
        txtFile.send();
	}

	function display_column(str_line, n)
	{
   		document.write("<p>" + str_line.split('\t')[n - 1]);
	}

	function display_all(data)
	{
   		var i, x = data.split('\n');
	   	for (i = 0; i < data.length; i++)
		{
      		display_column(data[i], 1);
	      	// it's 1 because you only want to display the 1st column..
      		// unless I misunderstood your question..
   		}
	}

	function download()
	{
		window.open(buttonLink);
	}
//-->
</script>
<noscript>
    <style>
        #slideshow {display:none;}
    </style>
</noscript>

</head>
<body class="Implementing a Protocol - Instant Messaging" style="background-image: none">
<div id="meet-banner" style="background-color: #1d76ba;">
    <p style="color: #fff; padding: 20px;">
        If you are looking for Jitsi Meet, the WebRTC compatible video conferencing product click <a href="https://jitsi.org">here</a>.
    </p>
</div>
<!--PageHeaderFmt-->
  	<div id="wrapper">
		<div id="header">
			<!--ul id="headernavigation">
						<li class="left"><a href="#">Sitemap</a></li>
						<li><a href="#">Contact</a></li>
						<li class="search"><form action='https://desktop.jitsi.org' style="padding:0; margin:0"><input type='hidden' name='n' value='Documentation.HowToImplementProtocols7' /><input type='hidden' name='action' value='search' /><input type="text" name="q" onblur="if(this.value=='')this.value='Search...';" onfocus="if(this.value=='Search...')this.value=''" value="Search..." class="text" /><input type="submit" value="" class="submit"/></form></li>
			</ul--> 
	   <div id="menubar" style="display: block;">
				<div> 
			      	<span>
				    	<a href='https://desktop.jitsi.org/Documentation/HowToImplementProtocols7?action=edit' accesskey='e' style="display: none;">>Edit Page</a>
		    			
			        </span>
				</div> 
     			<div class="clear"></div>

        </div>
						
		<div id="logo">
			<a href="../index.html">
				<img  src="../wiki/pub/sip-communicator/logo3.png" />
			</a>
		</div>		
		
        <div id="menu" style="display: block;">	
	       
            <span id="popupmenu" style="float: left;">
			    <ul id="navigation">
            		<li class="first" id="Main"><a class="mainmenu"><span>Jitsi</span></a>
                    	<ul><li><a class='wikilink' href='../'>Home</a>
</li><li><a class='wikilink' href='../Main/News.html'>News</a>
</li><li><a class='wikilink' href='../Main/Download.html'>Download</a>
</li><li><a class='wikilink' href='../Main/Screenshots.html'>Screenshots</a>
</li><li><a class='wikilink' href='../Main/Features.html'>Features</a>
</li><li><a class='wikilink' href='../Main/About.html'>About</a>
</li></ul>
 
                    </li>                     
	               	<li id="Download"><a class="mainmenu" href="../Main/Download.html"><span>Download</span></a>
						

					</li>
                    <li id="Development"><a class="mainmenu"><span>Development</span></a>
                    	<ul><li><a class='wikilink' href='../Development/CommunityForum.html'>Commmunity Forum</a>
</li><li><a class='wikilink' href='../Development/VersionControl.html'>Source Code</a>
</li><li><a class='wikilink' href='../Development/TeamAndContributors.html'>Team and Contributors</a>
</li><li><a class='urllink' href='https://github.com/jitsi' rel='nofollow'>GitHub project page</a>
</li><li>Jitsi Family
</li><li><a class='urllink' href='https://jitsi.org/meet' rel='nofollow'>Jitsi Meet</a>
</li><li><a class='urllink' href='https://jitsi.org/libjitsi' rel='nofollow'>LibJitsi</a>
</li><li><a class='urllink' href='http://ice4j.org' rel='nofollow'>ice4j.org</a>
</li><li><a class='urllink' href='https://jitsi.org/jitsi-videobridge' rel='nofollow'>Jitsi Videobridge</a>
</li></ul>

					</li>
					<li id="Documentation"><a class="mainmenu"><span>Documentation</span></a>
						<ul><li><a class='wikilink' href='UserDocumentation.html'>User Documentation</a>
</li><li><a class='wikilink' href='DeveloperDocumentation.html'>Developer Documentation</a>
</li><li><a class='wikilink' href='FAQ.html'>FAQ</a>
</li><li><a class='wikilink' href='ZrtpFAQ.html'>ZRTP and SRTP FAQ</a>
</li></ul>

					</li>
				
					<!--li class="last" id="Support"><a class="mainmenu"><span>Support</span></a-->
	                 	<ul><li><a class='wikilink' href='../Commercial/Companies.html'>Support and Custom Development</a>
</li></ul>
	 					
					<!--/li-->
				</ul>
			</span>
			<div class="clear"></div>
		   </div>
		
        </div>
        
		<div id="content">
			 			<!--PageText-->
<div id='wikitext'>
<p><a class='wikilink' href='HowToImplementProtocols6.html'>previous</a> | <a class='wikilink' href='HowToImplementProtocols.html'>TOC</a> | <a class='wikilink' href='HowToImplementProtocols8.html'>next</a>
</p><div style='width:960px; margin:40px auto;text-align:left' >
<div id='separator' >
</div><div >
<h1>Implementing a Protocol</h1>
</div><div id='subttl' >
<p>OperationSetBasicInstantMessaging.
</p></div>
<p class='vspace'>Why basic? Because in here we only send single messages and receive events for incoming single messages. We don&rsquo;t have concepts of conversations, chatrooms, rendezvous points or anything of that kind. Other operation sets cover these notions or will cover them one day whenever it is that we happen to need them.
</p>
<p class='vspace'>So what it is, again that we do here? 
</p><div id='separator' >
</div><div >
</div><div id='subttl' >
<p>Creating messages and the Message interface.
</p></div>
<p class='vspace'>Since the send methods would take a <em>Message</em> parameter we would first have to implement that one and provide a method that would allow other bundles to instantiate it.
</p>
<p class='vspace'>The <a class='urllink' href='https://sip-communicator.dev.java.net/source/browse/*checkout*/sip-communicator/trunk/src/net/java/sip/communicator/impl/protocol/gibberish/MessageGibberishImpl.java' rel='nofollow'><em>MessageGibberishImpl</em></a> implementation does this in a very straight forward manner. It simply keeps a String for the actual message body as well as an identifier, a subject (ofteh ignored), and som other details. Don&rsquo;t hesitate to go have a look on the class itself. 
</p>
<p class='vspace'>We instantiate <em>Gibberish</em> messages in the <em>createMessage()</em>methods of the basic instant messaging operation set, like this:
</p>
<div class='vspace'></div><div class='sourceblock'>
<div class='sourceblocklink'><a href='HowToImplementProtocols7&amp;ref=1.html' type='text/plain'>[&#036;[Get Code]]</a></div><div class='sourceblocktext'><div class="java" style="font-family: monospace;"><span class="kw2">public</span> Message createMessage<span class="br0">&#40;</span><span class="kw4">byte</span><span class="br0">&#91;</span><span class="br0">&#93;</span> content, <a href="http://www.google.com/search?q=allinurl%3AString+java.sun.com&amp;bntl=1"><span class="kw3">String</span></a> contentType,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.google.com/search?q=allinurl%3AString+java.sun.com&amp;bntl=1"><span class="kw3">String</span></a> contentEncoding, <a href="http://www.google.com/search?q=allinurl%3AString+java.sun.com&amp;bntl=1"><span class="kw3">String</span></a> subject<span class="br0">&#41;</span><br />
<span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw2">return</span> <span class="kw2">new</span> MessageGibberishImpl<span class="br0">&#40;</span><span class="kw2">new</span> <a href="http://www.google.com/search?q=allinurl%3AString+java.sun.com&amp;bntl=1"><span class="kw3">String</span></a><span class="br0">&#40;</span>content<span class="br0">&#41;</span>, contentType<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;, contentEncoding, subject<span class="br0">&#41;</span>;<br />
<span class="br0">&#125;</span><br />
<br />
<span class="kw2">public</span> Message createMessage<span class="br0">&#40;</span><a href="http://www.google.com/search?q=allinurl%3AString+java.sun.com&amp;bntl=1"><span class="kw3">String</span></a> messageText<span class="br0">&#41;</span><br />
<span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw2">return</span> <span class="kw2">new</span> MessageGibberishImpl<span class="br0">&#40;</span>messageText, DEFAULT_MIME_TYPE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; , DEFAULT_MIME_ENCODING, <span class="kw2">null</span><span class="br0">&#41;</span>;<br />
<span class="br0">&#125;</span></div></div></div>
<div class='vspace'></div><div id='separator' >
</div><div >
</div><div id='subttl' >
<p>Sending messages.
</p></div>
<p class='vspace'>This is an extremely simple business in general and implementing it would most of the time come down to simply wrapping the <em>sendInstantMessage()</em> method around the one that your stack is offering. In <em>Gibberish</em> this we have it this way:
</p>
<div class='vspace'></div><div class='sourceblock'>
<div class='sourceblocklink'><a href='HowToImplementProtocols7&amp;ref=2.html' type='text/plain'>[&#036;[Get Code]]</a></div><div class='sourceblocktext'><div class="java" style="font-family: monospace;"><span class="kw2">public</span> <span class="kw4">void</span> sendInstantMessage<span class="br0">&#40;</span>Contact to, Message message<span class="br0">&#41;</span> <span class="kw2">throws</span><br />
&nbsp; &nbsp; <a href="http://www.google.com/search?q=allinurl%3AIllegalStateException+java.sun.com&amp;bntl=1"><span class="kw3">IllegalStateException</span></a>, <a href="http://www.google.com/search?q=allinurl%3AIllegalArgumentException+java.sun.com&amp;bntl=1"><span class="kw3">IllegalArgumentException</span></a><br />
<span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span> !<span class="br0">&#40;</span>to instanceof ContactGibberishImpl<span class="br0">&#41;</span> <span class="br0">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw2">throw</span> <span class="kw2">new</span> <a href="http://www.google.com/search?q=allinurl%3AIllegalArgumentException+java.sun.com&amp;bntl=1"><span class="kw3">IllegalArgumentException</span></a><span class="br0">&#40;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="st0">&quot;The specified contact is not a Gibberish contact.&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ to<span class="br0">&#41;</span>;<br />
<br />
&nbsp; &nbsp; MessageDeliveredEvent msgDeliveredEvt<br />
&nbsp; &nbsp; &nbsp; &nbsp; = <span class="kw2">new</span> MessageDeliveredEvent<span class="br0">&#40;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; message, to, <span class="kw2">new</span> <a href="http://www.google.com/search?q=allinurl%3ADate+java.sun.com&amp;bntl=1"><span class="kw3">Date</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;<br />
<br />
&nbsp; &nbsp; <span class="co1">//first fire an event that we've delivered the message.</span><br />
&nbsp; &nbsp; <span class="co1">//Note that in a real world protocol implementation we would first wait</span><br />
&nbsp; &nbsp; <span class="co1">//for a delivery confirmation coming from the protocol stack.</span><br />
&nbsp; &nbsp; fireMessageDelivered<span class="br0">&#40;</span>message, to<span class="br0">&#41;</span>;<br />
<br />
&nbsp; &nbsp; <span class="co1">//now do message delivery.</span><br />
&nbsp; &nbsp; deliverMessage<span class="br0">&#40;</span>message, <span class="br0">&#40;</span>ContactGibberishImpl<span class="br0">&#41;</span>to<span class="br0">&#41;</span>;<br />
<span class="br0">&#125;</span></div></div></div>
<p class='vspace'><em>Note, (and remember) the comment before the fireMessageDelivered() call.</em>
</p>
<p class='vspace'>In a real world implementation the <em>deliverMessage()</em> method would actually be a method coming from the protocol stack that sends the instant message in a protocol specific way. That&rsquo;s kind of  what it does here too:
</p>
<div class='vspace'></div><div class='sourceblock'>
<div class='sourceblocklink'><a href='HowToImplementProtocols7&amp;ref=3.html' type='text/plain'>[&#036;[Get Code]]</a></div><div class='sourceblocktext'><div class="java" style="font-family: monospace;"><span class="kw2">private</span> <span class="kw4">void</span> deliverMessage<span class="br0">&#40;</span>Message message, ContactGibberishImpl to<span class="br0">&#41;</span><br />
<span class="br0">&#123;</span><br />
&nbsp; &nbsp; <a href="http://www.google.com/search?q=allinurl%3AString+java.sun.com&amp;bntl=1"><span class="kw3">String</span></a> userID = to.<span class="me1">getAddress</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;<br />
<br />
&nbsp; &nbsp; <span class="co1">//if the user id is owr own id, then this message is being routed to us</span><br />
&nbsp; &nbsp; <span class="co1">//from another instance of the gibberish provider.</span><br />
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>userID.<span class="me1">equals</span><span class="br0">&#40;</span><span class="kw2">this</span>.<span class="me1">parentProvider</span>.<span class="me1">getAccountID</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getUserID</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><br />
&nbsp; &nbsp; <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//check who is the provider sending the message</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <a href="http://www.google.com/search?q=allinurl%3AString+java.sun.com&amp;bntl=1"><span class="kw3">String</span></a> sourceUserID<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = to.<span class="me1">getProtocolProvider</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getAccountID</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getUserID</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//check whether they are in our contact list</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; Contact from = opSetPersPresence.<span class="me1">findContactByID</span><span class="br0">&#40;</span>sourceUserID<span class="br0">&#41;</span>;<br />
<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//and if not - add them there as volatile.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>from == <span class="kw2">null</span><span class="br0">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from = opSetPersPresence.<span class="me1">createVolatileContact</span><span class="br0">&#40;</span>sourceUserID<span class="br0">&#41;</span>;<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//and now fire the message received event.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; fireMessageReceived<span class="br0">&#40;</span>message, from<span class="br0">&#41;</span>;<br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="kw1">else</span><br />
&nbsp; &nbsp; <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//if userID is not our own, try an check whether another provider</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//has that id and if yes - deliver the message to them.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ProtocolProviderServiceGibberishImpl gibberishProvider<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = <span class="kw2">this</span>.<span class="me1">opSetPersPresence</span>.<span class="me1">findProviderForGibberishUserID</span><span class="br0">&#40;</span>userID<span class="br0">&#41;</span>;<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>gibberishProvider != <span class="kw2">null</span><span class="br0">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OperationSetBasicInstantMessagingGibberishImpl opSetIM<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = <span class="br0">&#40;</span>OperationSetBasicInstantMessagingGibberishImpl<span class="br0">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gibberishProvider.<span class="me1">getOperationSet</span><span class="br0">&#40;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OperationSetBasicInstantMessaging.<span class="kw2">class</span><span class="br0">&#41;</span>;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; opSetIM.<span class="me1">deliverMessage</span><span class="br0">&#40;</span>message, to<span class="br0">&#41;</span>;<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//if we got here then &quot;to&quot; is simply someone in our contact</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//list so let's just echo the message.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fireMessageReceived<span class="br0">&#40;</span>message, to<span class="br0">&#41;</span>;<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br />
&nbsp; &nbsp; <span class="br0">&#125;</span><br />
<span class="br0">&#125;</span></div></div></div>
<p class='vspace'>Reminder: what we want the <em>Gibberish</em> protocol to do is either echo messages back to us or, in case there is another provider registered with the same name as the account we&rsquo;re writing to, deliver the message to that provider. 
</p>
<p class='vspace'>This gives us the following three cases in the deliverMessage() method:
</p>
<div class='vspace'></div><ol><li>Another protocol provider would like to send us a message - in this case we check whether we have them in our contact list and if not we add them as a non-persistent contact, then we deliver the instant message to the user as one being sent from that contact.
<div class='vspace'></div></li><li>The second case is actually the opposite of the first one. The user id that we are trying to deliver the message to is not our own so we try to find whether another provider has that id, if they do, then we call their <em>deliverMessage()</em> method and it would execute its case 1 just as we described it above.
<div class='vspace'></div></li><li>The third case actually handles all the bogus contacts that a user can write to in the <em>Gibberish</em> protocol and it simply echos the message back to the user. 
</li></ol><p class='vspace'>And that&rsquo;s it!
</p><div id='separator' >
</div><div >
</div></div>
<p><a class='wikilink' href='HowToImplementProtocols6.html'>previous</a> | <a class='wikilink' href='HowToImplementProtocols.html'>TOC</a> | <a class='wikilink' href='HowToImplementProtocols8.html'>next</a>
</p>
</div>
	
			<div id="clear"></div>	
			
		</div>
		<div id="push"></div>
	</div>	
		<div id="footer">
			<div id="footerwrap"> 
			        
					<div class="fcleft">
							
							Jitsi is distributed under the terms of the Apache License, Version 2.0
						
					</div> 
					<!--div class="fccontact">
						<b>Contacts</b><br/>
						mail: contact@bluejimp.com<br/>
                        sip: bluejimp@ippi.fr <br/>
						phone France: +33 1 77 62 43 30<br/>
						phone USA: +1 415 762 0439
					</div>
					<div class="fccontact">
						<b>Head Office - France</b><br/>
						Strasbourg, France<br/><br/>
						phone: +33 1 77 62 43 30<br/>
						fax: +33 1 77 62 47 31
					</div>
					<div class="fccontact">
                        <b>Bulgarian Branch</b><br/>headernavigation
                        34 Nikolay Haitov Str.<br/>
                        1172 Sofia, Bulgaria<br/>
                        phone: +359 2 868 75 74<br/>
                        phone: +359 2 868 88 49 
                    </div-->
					<div class="fcright">
					   <div style="position:relative;z-index:3;width:367px;text-align:right;">					
					          Powered by: <a href="http://pmwiki.org" rel="external">pmwiki</a>
					   </div>	
					<!--	<div id="logoimage" >	
						    	  <img  src="https://desktop.jitsi.org/wiki/pub/sip-communicator/footerimage.png" />
						</div>-->			    					   
					</div>								
					</div>
				
										
			</div>

</body></html>
